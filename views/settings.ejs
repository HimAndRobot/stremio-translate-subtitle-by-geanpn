<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Stremio Translate Subtitle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/public/translation-config.js?v=<%= Date.now() %>"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8fafc;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .tab-active {
            background-color: #6366f1 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="text-slate-900 antialiased flex flex-col min-h-screen">

    <%- include('partials/settings/header') %>

    <main class="max-w-7xl mx-auto px-6 py-10 w-full flex-1">
        <div class="flex flex-col lg:flex-row gap-8">

            <%- include('partials/settings/sidebar') %>

            <div class="flex-1">
                <%- include('partials/settings/credentials') %>
            </div>

        </div>
    </main>

    <%- include('partials/settings/master-password-modal') %>
    <%- include('partials/settings/delete-confirmation-modal') %>

    <footer class="mt-auto py-10 border-t border-slate-200 bg-white shrink-0">
        <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row items-center justify-between gap-6 text-slate-400">
            <span class="text-[10px] font-bold uppercase tracking-[0.2em]">Secure Settings - Stremio Translate Subtitle</span>
            <a href="https://github.com/HimAndRobot/stremio-translate-subtitle-by-geanpn" target="_blank" class="flex items-center gap-2 text-slate-500 hover:text-slate-900 transition-colors text-xs font-bold uppercase tracking-widest">
                <i data-lucide="github" class="w-5 h-5"></i> GitHub
            </a>
        </div>
    </footer>

    <script>
        lucide.createIcons();

        let pendingCredential = null;

        function initializeProviders() {
            const providerSelect = document.getElementById('cred-provider');
            PROVIDERS.forEach(provider => {
                if (provider !== 'Google Translate') {
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = provider;
                    providerSelect.appendChild(option);
                }
            });
        }

        function updateProviderFields() {
            const provider = document.getElementById('cred-provider').value;
            if (!provider) {
                document.getElementById('apikey-group').classList.add('hidden');
                document.getElementById('baseurl-group').classList.add('hidden');
                document.getElementById('model-group').classList.add('hidden');
                return;
            }

            const config = PROVIDER_CONFIGS[provider];

            document.getElementById('apikey-group').classList.toggle('hidden', !config.requiresApiKey);
            document.getElementById('baseurl-group').classList.toggle('hidden', !config.requiresBaseUrl);
            document.getElementById('model-group').classList.toggle('hidden', !config.requiresModel);

            document.getElementById('cred-apikey').required = config.requiresApiKey;
            document.getElementById('cred-baseurl').required = false;
            document.getElementById('cred-model').required = false;

            if (config.defaultBaseUrl) {
                document.getElementById('cred-baseurl').value = config.defaultBaseUrl;
            }

            const modelSelect = document.getElementById('cred-model');
            modelSelect.innerHTML = '<option value="">Select model</option>';

            if (config.models && config.models.length > 0) {
                config.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    if (model === config.defaultModel) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('text-slate-500');
            });

            const activeTab = document.getElementById('tab-' + tabName);
            if (activeTab) {
                activeTab.classList.add('tab-active');
                activeTab.classList.remove('text-slate-500');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/admin/logout', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = data.redirect;
                        }
                    })
                    .catch(err => {
                        console.error('Logout error:', err);
                        alert('Error logging out');
                    });
            }
        }

        async function deriveKey(password, salt) {
            if (!window.crypto || !window.crypto.subtle) {
                throw new Error('Web Crypto API not available. Please use HTTPS or localhost.');
            }

            const encoder = new TextEncoder();
            const passwordBuffer = encoder.encode(password);

            const importedKey = await window.crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );

            return window.crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                importedKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const key = await deriveKey(password, salt);

            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                encoder.encode(JSON.stringify(data))
            );

            return {
                encrypted: Array.from(new Uint8Array(encrypted)),
                salt: Array.from(salt),
                iv: Array.from(iv)
            };
        }

        async function decryptData(encryptedData, salt, iv, password) {
            const key = await deriveKey(password, new Uint8Array(salt));

            const decrypted = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: new Uint8Array(iv) },
                key,
                new Uint8Array(encryptedData)
            );

            const decoder = new TextDecoder();
            return JSON.parse(decoder.decode(decrypted));
        }

        function saveCredential(event) {
            event.preventDefault();

            const name = document.getElementById('cred-name').value;
            const provider = document.getElementById('cred-provider').value;
            const apikey = document.getElementById('cred-apikey').value;
            const baseurl = document.getElementById('cred-baseurl').value;
            const model = document.getElementById('cred-model').value;

            pendingCredential = {
                name: name,
                provider: provider,
                apikey: apikey,
                baseurl: baseurl,
                model: model
            };

            document.getElementById('master-password-modal').classList.remove('hidden');
            document.getElementById('master-password-modal').classList.add('flex');
            document.getElementById('master-password-input').value = '';
            document.getElementById('master-password-input').focus();
        }

        function closeMasterPasswordModal() {
            document.getElementById('master-password-modal').classList.remove('flex');
            document.getElementById('master-password-modal').classList.add('hidden');
            pendingCredential = null;
        }

        async function confirmMasterPassword() {
            const masterPassword = document.getElementById('master-password-input').value;

            if (!masterPassword) {
                showToast('Please enter a master password', 'error');
                return;
            }

            try {
                const sensitiveData = {
                    apikey: pendingCredential.apikey,
                    baseurl: pendingCredential.baseurl,
                    model: pendingCredential.model
                };

                const encrypted = await encryptData(sensitiveData, masterPassword);

                const credentials = JSON.parse(localStorage.getItem('user_credentials') || '[]');

                credentials.push({
                    name: pendingCredential.name,
                    provider: pendingCredential.provider,
                    encrypted_data: encrypted.encrypted,
                    salt: encrypted.salt,
                    iv: encrypted.iv
                });

                localStorage.setItem('user_credentials', JSON.stringify(credentials));

                closeMasterPasswordModal();
                document.getElementById('credential-form').reset();
                updateProviderFields();
                loadCredentials();

                showToast('Credential saved successfully!', 'success');
            } catch (error) {
                console.error('Encryption error:', error);
                showToast('Error encrypting credential: ' + error.message, 'error');
            }
        }

        function loadCredentials() {
            const credentials = JSON.parse(localStorage.getItem('user_credentials') || '[]');
            const container = document.getElementById('credentials-container');
            const badge = document.getElementById('cred-count-badge');

            badge.innerText = credentials.length + ' Items';

            if (credentials.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full py-12 text-center text-slate-300 border-2 border-dashed border-slate-100 rounded-[32px]">
                        <i data-lucide="key" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                        <p class="text-sm font-bold uppercase tracking-widest">No credentials saved yet</p>
                        <p class="text-xs text-slate-400 mt-1">Add your first API credential using the form above</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = credentials.map((cred, index) => {
                const initials = cred.provider.substring(0, 2).toUpperCase();
                return `
                    <div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100 flex items-center justify-between group transition-all hover:shadow-md hover:border-slate-200">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center font-black text-lg">
                                ${initials}
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-slate-800">${cred.name}</h4>
                                <span class="text-[10px] font-black text-indigo-500 uppercase tracking-tighter">${cred.provider}</span>
                            </div>
                        </div>
                        <button onclick="deleteCredential(${index})" class="p-3 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all" title="Delete">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        let indexToDelete = null;

        function deleteCredential(index) {
            indexToDelete = index;
            const credentials = JSON.parse(localStorage.getItem('user_credentials') || '[]');
            const name = credentials[index].name;
            document.getElementById('delete-modal-text').innerText = `Are you sure you want to permanently delete the credential "${name}"? This action cannot be undone.`;
            document.getElementById('delete-confirmation-modal').classList.remove('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('flex');
            setTimeout(() => lucide.createIcons(), 50);
        }

        function closeDeleteModal() {
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('delete-confirmation-modal').classList.remove('flex');
            indexToDelete = null;
        }

        function confirmDeletion() {
            if (indexToDelete !== null) {
                const credentials = JSON.parse(localStorage.getItem('user_credentials') || '[]');
                credentials.splice(indexToDelete, 1);
                localStorage.setItem('user_credentials', JSON.stringify(credentials));
                loadCredentials();
                closeDeleteModal();
                showToast('Credential deleted successfully', 'info');
            }
        }

        function showToast(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: 'top',
                position: 'right',
                style: {
                    background: type === 'info' ? '#6366f1' : (type === 'error' ? '#ef4444' : '#10b981'),
                    borderRadius: '16px',
                    fontWeight: 'bold',
                    fontSize: '12px',
                    textTransform: 'uppercase'
                }
            }).showToast();
        }

        initializeProviders();
        loadCredentials();
    </script>
</body>
</html>
